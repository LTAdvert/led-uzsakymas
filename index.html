<!DOCTYPE html>
<html lang="lt">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>LT Advert - Rezervavimo Sistema</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://unpkg.com/react@18/umd/react.production.min.js"></script>
    <script src="https://unpkg.com/react-dom@18/umd/react-dom.production.min.js"></script>
    <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>
    <script src="https://unpkg.com/xlsx/dist/xlsx.full.min.js"></script>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;700;900&display=swap" rel="stylesheet">
    <style>
        html, body, #root { height: 100%; margin: 0; padding: 0; }
        body { font-family: 'Inter', sans-serif; overflow: hidden; background-color: #f8fafc; }
        .custom-scrollbar::-webkit-scrollbar { width: 4px; height: 4px; }
        .custom-scrollbar::-webkit-scrollbar-track { background: transparent; }
        .custom-scrollbar::-webkit-scrollbar-thumb { background: #E2E8F0; border-radius: 20px; }
        .custom-scrollbar::-webkit-scrollbar-thumb:hover { background: #00A650; }
        input::-webkit-outer-spin-button, input::-webkit-inner-spin-button { -webkit-appearance: none; margin: 0; }
        select { -webkit-appearance: none; -moz-appearance: none; appearance: none; }
        .modal-overlay { background-color: rgba(15, 23, 42, 0.6); backdrop-filter: blur(4px); }
        @media print {
            .no-print { display: none !important; }
            .print-only { display: block !important; }
            body { background: white; overflow: visible; }
            .modal-overlay { background: white; position: absolute; inset: 0; backdrop-filter: none; }
            .overflow-x-auto { overflow-x: visible !important; } /* Allow table to expand in print */
        }
        .active-row { border-left: 4px solid #00A650 !important; background-color: #f0fdf4 !important; }
    </style>
</head>
<body class="text-slate-800 antialiased text-left">
    <div id="root"></div>

    <script type="text/babel">
        const { useState, useMemo, useEffect } = React;

        // --- KONSTANTOS IR IKONOS ---
        const TOP_5_CITIES = ['Vilnius', 'Kaunas', 'Klaipėda', 'Šiauliai', 'Panevėžys'];
        const DAYS = ['Pi', 'An', 'Tr', 'Ke', 'Pe', 'Še', 'Se'];
        const HOURS = Array.from({ length: 18 }, (_, i) => `${(i + 6).toString().padStart(2, '0')}:00`);

        const Icons = {
            Calendar: ({ size = 18 }) => <svg width={size} height={size} viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2.5" strokeLinecap="round" strokeLinejoin="round"><rect x="3" y="4" width="18" height="18" rx="2" ry="2"></rect><line x1="16" y1="2" x2="16" y2="6"></line><line x1="8" y1="2" x2="8" y2="6"></line><line x1="3" y1="10" x2="21" y2="10"></line></svg>,
            Check: ({ size = 16, className = "" }) => <svg width={size} height={size} viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="3.5" strokeLinecap="round" strokeLinejoin="round" className={className}><polyline points="20 6 9 17 4 12"></polyline></svg>,
            Search: () => <svg width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2.5" strokeLinecap="round" strokeLinejoin="round"><circle cx="11" cy="11" r="8"></circle><line x1="21" y1="21" x2="16.65" y2="16.65"></line></svg>,
            ChevronDown: () => <svg width="12" height="12" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2.5" strokeLinecap="round" strokeLinejoin="round"><polyline points="6 9 12 15 18 9"></polyline></svg>,
            Plus: ({ size = 16 }) => <svg width={size} height={size} viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2.5" strokeLinecap="round" strokeLinejoin="round"><line x1="12" y1="5" x2="12" y2="19"></line><line x1="5" y1="12" x2="19" y2="12"></line></svg>,
            Eye: ({ size = 16 }) => <svg width={size} height={size} viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2.5" strokeLinecap="round" strokeLinejoin="round"><path d="M1 12s4-8 11-8 11 8 11 8-4 8-11 8-11-8-11-8z"></path><circle cx="12" cy="12" r="3"></circle></svg>,
            Trash: ({ size = 14 }) => <svg width={size} height={size} viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round"><polyline points="3 6 5 6 21 6"></polyline><path d="M19 6v14a2 2 0 0 1-2 2H7a2 2 0 0 1-2-2V6m3 0V4a2 2 0 0 1 2-2h4a2 2 0 0 1 2 2v2"></path></svg>,
            ArrowRight: () => <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2.5" strokeLinecap="round" strokeLinejoin="round"><line x1="5" y1="12" x2="19" y2="12"></line><polyline points="12 5 19 12 12 19"></polyline></svg>,
            ArrowLeft: () => <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2.5" strokeLinecap="round" strokeLinejoin="round"><line x1="19" y1="12" x2="5" y2="12"></line><polyline points="12 19 5 12 12 5"></polyline></svg>,
            Zap: ({ size = 12 }) => <svg width={size} height={size} viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2.5" strokeLinecap="round" strokeLinejoin="round"><polygon points="13 2 3 14 12 14 11 22 21 10 12 10 13 2"></polygon></svg>,
            Edit: () => <svg width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2.5" strokeLinecap="round" strokeLinejoin="round"><path d="M11 4H4a2 2 0 0 0-2 2v14a2 2 0 0 0 2 2h14a2 2 0 0 0 2-2v-7"></path><path d="M18.5 2.5a2.121 2.121 0 0 1 3 3L12 15l-4 1 1-4 9.5-9.5z"></path></svg>,
            FileCheck: ({ size = 16 }) => <svg width={size} height={size} viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2.5" strokeLinecap="round" strokeLinejoin="round"><path d="M14 2H6a2 2 0 0 0-2 2v16a2 2 0 0 0 2 2h12a2 2 0 0 0 2-2V8z"></path><polyline points="14 2 14 8 20 8"></polyline><path d="M9 15l2 2 4-4"></path></svg>,
            User: ({ size = 16 }) => <svg width={size} height={size} viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2.5" strokeLinecap="round" strokeLinejoin="round"><path d="M20 21v-2a4 4 0 0 0-4-4H8a4 4 0 0 0-4 4v2"></path><circle cx="12" cy="7" r="4"></circle></svg>
        };

        const Logo = ({ size = "text-xl" }) => {
            const isLarge = size.includes("5xl");
            return (
                <div className="flex flex-col items-start select-none text-left">
                    <div className={`${isLarge ? 'text-4xl' : 'text-xl'} font-black text-slate-900 tracking-tighter uppercase leading-none`}>
                        LT ADVERT
                    </div>
                </div>
            );
        };

        const ALL_SCREENS_DATA = [
            { id: 'VLED-1', city: 'Vilnius', address: 'Jasinskio g. 12 VLN', screen: 'OPERA (J. Lelevelio g. 4)', resolution: '640x360 px', size: '18 m²', type: 'Dinaminis', ots: 85000, basePrice: 500 },
            { id: 'VLED-2', city: 'Vilnius', address: 'Švitrigailos g. 33 VLN', screen: 'PEDAGOGINIS (Konstitucijos pr.)', resolution: '640x360 px', size: '18 m²', type: 'Dinaminis', ots: 55000, basePrice: 280 },
            { id: 'VLED-3', city: 'Vilnius', address: 'Kalvarijų g. 61 VLN', screen: 'EUROPA (Konstitucijos pr. 7)', resolution: '864x432 px', size: '18 m²', type: 'Dinaminis', ots: 92000, basePrice: 480 },
            { id: 'VLED-4', city: 'Vilnius', address: 'Konstitucijos pr. 7', screen: 'G. VILKO ŽIEDAS', resolution: '640x360 px', size: '18 m²', type: 'Dinaminis', ots: 88000, basePrice: 470 },
            { id: 'KLED-1', city: 'Kaunas', address: 'Taikos pr. 79', screen: 'DRAUGYSTĖS (Taikos pr. 79)', resolution: '512x384 px', size: '18 m²', type: 'Dinaminis', ots: 45000, basePrice: 220 },
            { id: 'KLLED-1', city: 'Klaipėda', address: 'Taikos pr. 14', screen: 'TAIKOS 14', resolution: '512x384 px', size: '18 m²', type: 'Dinaminis', ots: 65000, basePrice: 380 },
        ];

        const CLIENTS_INIT_DATA = [
            { id: 'C-1', name: 'Viada LT, UAB', type: 'Klientas' },
            { id: 'C-2', name: 'BPN LT, UAB', type: 'Užsakovas' },
            { id: 'C-3', name: 'Inspired', type: 'Klientas' },
            { id: 'C-4', name: 'Telia Lietuva', type: 'Užsakovas' },
        ];

        const ADVERTISERS_DATA = [
            { id: 'A-1', name: 'VIADA LT' }
        ];

        const WEEKLY_FREQUENCIES = [
            { id: 'f1', label: '1200', multiplier: 1, base: 1200 },
            { id: 'f2', label: '1800', multiplier: 1.4, base: 1800 },
            { id: 'f3', label: '3600', multiplier: 2.5, base: 3600 },
            { id: 'f4', label: 'Pikas', multiplier: 4.8, base: 7200 },
        ];

        // Helper function to get week number
        const getWeekNumber = (date) => {
            const d = new Date(Date.UTC(date.getFullYear(), date.getMonth(), date.getDate()));
            const dayNum = d.getUTCDay() || 7;
            d.setUTCDate(d.getUTCDate() + 4 - dayNum);
            const yearStart = new Date(Date.UTC(d.getUTCFullYear(),0,1));
            return Math.ceil((((d - yearStart) / 86400000) + 1)/7);
        };

        function App() {
            const [view, setView] = useState('registry'); // 'registry', 'meta', 'builder'
            const [savedOrders, setSavedOrders] = useState([]);
            
            // Meta duomenys
            const [orderMeta, setOrderMeta] = useState({
                id: null, 
                nr: '',
                date: new Date().toISOString().split('T')[0],
                customer: '',
                agent: '',
                advertiser: '',
                status: 'Pasiūlymas',
                manager: 'Vaiva Petrušina' // Numatytasis vadybininkas
            });

            // Projektai (blokai)
            const [projects, setProjects] = useState([]);
            const [isProjectModalOpen, setIsProjectModalOpen] = useState(false);
            const [editingProject, setEditingProject] = useState(null);
            
            // Naujas state ekranų parinkimui viduje projekto lango
            const [isScreenSelectOpen, setIsScreenSelectOpen] = useState(false);

            // Skaičiavimai kampanijai
            const calculateProjectStats = (proj) => {
                const diff = Math.ceil(Math.abs(new Date(proj.endDate) - new Date(proj.startDate)) / (1000 * 60 * 60 * 24));
                const durationDays = diff + 1; // +1 nes imtinai
                const weeks = Math.max(1, Math.round(durationDays / 7 * 10) / 10);
                const slotsCount = Object.values(proj.gridSelection || {}).filter(Boolean).length || 0;
                
                const baseSum = (proj.selectedScreens || []).reduce((acc, s) => acc + s.basePrice, 0);
                
                // Gross kaina per savaitę (bazinė kaina * multiplier * slots / 14)
                const weeklyGrossPerScreen = (basePrice) => Math.round(basePrice * proj.frequency.multiplier * (slotsCount / 14));
                
                // Bendra Gross kaina
                const totalGross = (proj.selectedScreens || []).reduce((acc, s) => acc + (weeklyGrossPerScreen(s.basePrice) * weeks), 0);
                
                // Netto kaina (su nuolaida)
                const price = Math.round(totalGross * (1 - (proj.discount || 80) / 100));

                return { 
                    price, 
                    totalGross,
                    weeks, 
                    slotsCount, 
                    durationDays,
                    screenCount: (proj.selectedScreens || []).length 
                };
            };

            const totalOrderPrice = useMemo(() => {
                return projects.reduce((acc, p) => acc + calculateProjectStats(p).price, 0);
            }, [projects]);

            // --- FUNKCIJOS ---

            const resetBuilder = () => {
                setOrderMeta({ 
                    id: null, 
                    nr: '', 
                    date: new Date().toISOString().split('T')[0], 
                    customer: '', 
                    agent: '', 
                    advertiser: '',
                    status: 'Pasiūlymas',
                    manager: 'Vaiva Petrušina'
                });
                setProjects([]);
                setScreenSelectorProjectIdx(null);
                setEditingProject(null);
            };

            const [screenSelectorProjectIdx, setScreenSelectorProjectIdx] = useState(null);

            const handleFinishOrder = () => {
                if (projects.length === 0) return;
                
                const orderData = {
                    ...orderMeta,
                    id: orderMeta.id || Date.now(),
                    totalPrice: totalOrderPrice,
                    projectsCount: projects.length,
                    projects: JSON.parse(JSON.stringify(projects)),
                    status: orderMeta.status || 'Pasiūlymas'
                };

                if (savedOrders.find(o => o.id === orderData.id)) {
                    setSavedOrders(savedOrders.map(o => o.id === orderData.id ? orderData : o));
                } else {
                    setSavedOrders([orderData, ...savedOrders]);
                }

                setView('registry');
                resetBuilder();
            };

            const handleOpenOrder = (order) => {
                setOrderMeta({
                    id: order.id,
                    nr: order.nr,
                    date: order.date,
                    customer: order.customer,
                    agent: order.agent,
                    advertiser: order.advertiser,
                    status: order.status,
                    manager: order.manager || 'Vaiva Petrušina'
                });
                setProjects(JSON.parse(JSON.stringify(order.projects)));
                setView('builder');
            };

            const handleConfirmOrder = (e, orderId) => {
                e.stopPropagation();
                setSavedOrders(savedOrders.map(o => o.id === orderId ? { ...o, status: 'Užsakymas' } : o));
            };

            const handleAddProject = () => {
                setEditingProject({
                    id: Math.random(),
                    name: '',
                    duration: '10s',
                    notes: '',
                    startDate: new Date().toISOString().split('T')[0],
                    endDate: new Date(Date.now() + 7 * 24 * 60 * 60 * 1000).toISOString().split('T')[0],
                    frequency: WEEKLY_FREQUENCIES[0],
                    gridSelection: {},
                    selectedScreens: [],
                    discount: 80 // Default nuolaida
                });
                setIsProjectModalOpen(true);
            };

            const saveProject = () => {
                let updatedProjects;
                if (projects.find(p => p.id === editingProject.id)) {
                    updatedProjects = projects.map(p => p.id === editingProject.id ? editingProject : p);
                } else {
                    updatedProjects = [...projects, editingProject];
                }
                setProjects(updatedProjects);
                setIsProjectModalOpen(false);
                setEditingProject(null);
            };

            const updateGridByFrequency = (freq) => {
                const newGrid = {};
                if (freq.id === 'f1') DAYS.forEach((day, dIdx) => HOURS.forEach((hour, hIdx) => { if (((hIdx - dIdx) % 3 + 3) % 3 === 0) newGrid[`${day}-${hour}`] = true; }));
                else if (freq.id === 'f2') DAYS.forEach((day, dIdx) => HOURS.forEach((hour, hIdx) => { if (((hIdx - dIdx) % 2 + 2) % 2 === 0) newGrid[`${day}-${hour}`] = true; }));
                else if (freq.id === 'f3') DAYS.forEach(day => HOURS.forEach(hour => newGrid[`${day}-${hour}`] = true));
                else if (freq.id === 'f4') DAYS.forEach(day => ['08:00', '09:00', '16:00', '17:00'].forEach(h => newGrid[`${day}-${h}`] = true));
                setEditingProject({...editingProject, frequency: freq, gridSelection: newGrid});
            };

            // --- EKRANŲ PARINKIMAS (Nauja logika) ---
            const [searchTerm, setSearchTerm] = useState('');
            const filteredScreens = useMemo(() => ALL_SCREENS_DATA.filter(s => s.city.toLowerCase().includes(searchTerm.toLowerCase()) || s.screen.toLowerCase().includes(searchTerm.toLowerCase())), [searchTerm]);

            const toggleScreenInEditingProject = (screen) => {
                if (!editingProject) return;
                const isSel = editingProject.selectedScreens.some(es => es.id === screen.id);
                const newList = isSel ? editingProject.selectedScreens.filter(s => s.id !== screen.id) : [...editingProject.selectedScreens, screen];
                setEditingProject({ ...editingProject, selectedScreens: newList });
            };
            
            // Screen toggling logic from the main list view
            const toggleScreenInProject = (screen) => {
                 if (screenSelectorProjectIdx === null) return;
                const proj = projects[screenSelectorProjectIdx];
                const isSel = proj.selectedScreens.some(s => s.id === screen.id);
                const newList = isSel ? proj.selectedScreens.filter(s => s.id !== screen.id) : [...proj.selectedScreens, screen];
                
                const newProjects = [...projects];
                newProjects[screenSelectorProjectIdx] = { ...proj, selectedScreens: newList };
                setProjects(newProjects);
            }

            // --- PDF PERŽIŪRA ---
            const [isPreviewOpen, setIsPreviewOpen] = useState(false);

            // --- REGISTRAS ---
            if (view === 'registry') return (
                <div className="h-screen flex flex-col bg-slate-50 text-left">
                    <header className="h-20 bg-white border-b border-slate-200 px-8 flex items-center justify-between shrink-0">
                        <Logo />
                        <button onClick={() => { resetBuilder(); setView('meta'); }} className="bg-[#00A650] text-white px-8 py-3 rounded-xl font-black uppercase text-xs shadow-lg flex items-center gap-2 hover:opacity-90 transition-all">
                            <Icons.Plus /> Naujas užsakymas
                        </button>
                    </header>
                    <main className="flex-1 overflow-y-auto p-12 custom-scrollbar">
                        <div className="max-w-7xl mx-auto space-y-8">
                            <h1 className="text-4xl font-black uppercase italic border-b-4 border-slate-900 pb-4 text-slate-900">Užsakymų Registras</h1>
                            <div className="bg-white border border-slate-200 rounded-[2rem] overflow-hidden shadow-lg">
                                <table className="w-full border-collapse text-left">
                                    <thead className="bg-slate-900 text-white text-[10px] font-black uppercase italic tracking-widest text-left">
                                        <tr>
                                            <th className="p-6">Nr / Data</th>
                                            <th>Užsakovas</th>
                                            <th>Klientas</th>
                                            <th>Vadybininkas</th>
                                            <th className="text-center">Projektai</th>
                                            <th className="text-right p-6">Suma</th>
                                            <th className="text-center">Statusas</th>
                                            <th className="p-6 text-center">Veiksmas</th>
                                        </tr>
                                    </thead>
                                    <tbody className="divide-y divide-slate-100 font-bold uppercase tracking-tight">
                                        {savedOrders.map(order => (
                                            <tr key={order.id} className="hover:bg-slate-50 group transition-colors cursor-pointer" onClick={() => handleOpenOrder(order)}>
                                                <td className="p-6 text-[11px] font-black text-slate-700">
                                                    <div className="text-slate-400 text-[8px] mb-0.5">{order.nr || 'BE NR.'}</div>{order.date}
                                                </td>
                                                <td className="p-6 text-[11px] font-black text-slate-900 italic">{order.customer || '-'}</td>
                                                <td className="p-6 text-[11px] text-slate-500 italic">{order.agent || '-'}</td>
                                                <td className="p-6 text-[11px] text-slate-700 italic">{order.manager || '-'}</td>
                                                <td className="p-6 text-center text-xs font-black">{order.projectsCount}</td>
                                                <td className="p-6 text-right text-lg font-black text-[#00A650] italic">€{order.totalPrice.toLocaleString()}</td>
                                                <td className="p-6 text-center">
                                                    <span className={`px-3 py-1 rounded-full text-[9px] font-black uppercase ${order.status === 'Užsakymas' ? 'bg-[#00A650] text-white' : 'bg-yellow-100 text-yellow-600'}`}>
                                                        {order.status}
                                                    </span>
                                                </td>
                                                <td className="p-6 text-center" onClick={e => e.stopPropagation()}>
                                                    {order.status === 'Pasiūlymas' ? (
                                                        <button 
                                                            onClick={(e) => handleConfirmOrder(e, order.id)}
                                                            className="flex items-center gap-1 mx-auto px-4 py-2 bg-slate-900 text-white rounded-lg text-[9px] font-black hover:bg-[#00A650] transition-all uppercase"
                                                        >
                                                            <Icons.FileCheck size={12} /> Patvirtinti
                                                        </button>
                                                    ) : (
                                                        <span className="text-[9px] text-slate-400 font-black italic">Patvirtinta</span>
                                                    )}
                                                </td>
                                            </tr>
                                        ))}
                                    </tbody>
                                </table>
                                {savedOrders.length === 0 && <div className="p-20 text-center italic text-slate-300 font-black uppercase tracking-[0.3em] text-sm text-center">Registras tuščias</div>}
                            </div>
                        </div>
                    </main>
                </div>
            );

            // --- META SUVEDIMAS ---
            if (view === 'meta') return (
                <div className="h-screen bg-slate-100 flex items-center justify-center p-6 text-left">
                    <div className="w-full max-w-md space-y-10">
                        <div className="flex justify-center"><Logo size="text-5xl" /></div>
                        <div className="bg-white p-10 rounded-[2.5rem] shadow-2xl space-y-6">
                            <h2 className="text-xl font-black uppercase italic border-b border-slate-100 pb-4 leading-none">Užsakymo informacija</h2>
                            <div className="space-y-4">
                                <div className="grid grid-cols-2 gap-4 text-left">
                                    <div className="space-y-1 text-left"><label className="text-[10px] font-black text-slate-400 uppercase tracking-widest ml-1 text-left">Nr.</label><input type="text" value={orderMeta.nr} onChange={e => setOrderMeta({...orderMeta, nr: e.target.value})} className="w-full bg-slate-50 border-2 border-slate-100 rounded-2xl py-3 px-6 text-sm font-bold focus:border-[#00A650] outline-none transition-all" placeholder="PVZ-2024" /></div>
                                    <div className="space-y-1 text-left"><label className="text-[10px] font-black text-slate-400 uppercase tracking-widest ml-1">Data</label><input type="date" value={orderMeta.date} onChange={e => setOrderMeta({...orderMeta, date: e.target.value})} className="w-full bg-slate-50 border-2 border-slate-100 rounded-2xl py-3 px-6 text-sm font-bold outline-none" /></div>
                                </div>
                                <div className="space-y-1 text-left">
                                    <label className="text-[10px] font-black text-slate-400 uppercase tracking-widest ml-1">Užsakovas</label>
                                    <select value={orderMeta.customer} onChange={e => setOrderMeta({...orderMeta, customer: e.target.value})} className="w-full bg-slate-50 border-2 border-slate-100 rounded-2xl py-3 px-6 text-sm font-bold outline-none focus:border-[#00A650]">
                                        <option value="">Pasirinkti...</option>
                                        {CLIENTS_INIT_DATA.filter(c => c.type === 'Užsakovas').map(c => <option key={c.id} value={c.name}>{c.name}</option>)}
                                    </select>
                                </div>
                                <div className="space-y-1 text-left">
                                    <label className="text-[10px] font-black text-slate-400 uppercase tracking-widest ml-1">Klientas</label>
                                    <select value={orderMeta.agent} onChange={e => setOrderMeta({...orderMeta, agent: e.target.value})} className="w-full bg-slate-50 border-2 border-slate-100 rounded-2xl py-3 px-6 text-sm font-bold outline-none focus:border-[#00A650]">
                                        <option value="">Pasirinkti...</option>
                                        {CLIENTS_INIT_DATA.filter(c => c.type === 'Klientas').map(c => <option key={c.id} value={c.name}>{c.name}</option>)}
                                    </select>
                                </div>
                                <div className="space-y-1 text-left">
                                    <label className="text-[10px] font-black text-slate-400 uppercase tracking-widest ml-1">Reklamuotojas</label>
                                    <select value={orderMeta.advertiser} onChange={e => setOrderMeta({...orderMeta, advertiser: e.target.value})} className="w-full bg-slate-50 border-2 border-slate-100 rounded-2xl py-3 px-6 text-sm font-bold outline-none focus:border-[#00A650]">
                                        <option value="">Pasirinkti...</option>
                                        {ADVERTISERS_DATA.map(a => <option key={a.id} value={a.name}>{a.name}</option>)}
                                    </select>
                                </div>
                                <div className="space-y-1 text-left">
                                    <label className="text-[10px] font-black text-slate-400 uppercase tracking-widest ml-1">Vadybininkas</label>
                                    <div className="flex items-center gap-2 bg-slate-50 border-2 border-slate-100 rounded-2xl py-3 px-6">
                                        <Icons.User size={14} className="text-slate-400" />
                                        <input type="text" value={orderMeta.manager} onChange={e => setOrderMeta({...orderMeta, manager: e.target.value})} className="w-full bg-transparent text-sm font-bold outline-none text-slate-700" />
                                    </div>
                                </div>
                            </div>
                            <button onClick={() => setView('builder')} className="w-full bg-[#00A650] text-white py-5 rounded-2xl font-black uppercase shadow-lg hover:opacity-90 active:scale-95 transition-all mt-4 flex items-center justify-center gap-2">
                                Formuoti užsakymą <Icons.ArrowRight />
                            </button>
                        </div>
                    </div>
                </div>
            );

            // --- DARBO LANGAS ---
            return (
                <div className="h-screen flex flex-col bg-white text-left">
                    <header className="h-20 border-b border-slate-100 px-8 flex items-center justify-between shrink-0 no-print text-left">
                        <div className="flex items-center gap-8 text-left">
                            <button 
                                onClick={() => setView('registry')} 
                                className="p-2 text-slate-400 hover:text-slate-900 transition-colors"
                                title="Grįžti į registrą"
                            >
                                <Icons.ArrowLeft size={24} />
                            </button>
                            <Logo size="text-xl" />
                            <div className="flex flex-col leading-tight border-l border-slate-200 pl-8">
                                <span className="text-[10px] font-black text-slate-400 uppercase tracking-widest italic">{orderMeta.customer || 'Užsakovas'}</span>
                                <span className="text-sm font-black text-slate-900 italic uppercase">{orderMeta.agent || 'Klientas'}</span>
                            </div>
                        </div>
                        <div className="flex flex-col items-end leading-none">
                            <span className="text-[9px] font-black text-slate-400 uppercase tracking-widest italic mb-1 uppercase text-right">Bendra užsakymo suma</span>
                            <span className="text-xl font-black text-[#00A650] italic tracking-tighter leading-none text-right">€{totalOrderPrice.toLocaleString()}</span>
                        </div>
                    </header>

                    <main className="flex-1 overflow-y-auto p-8 custom-scrollbar no-print text-left">
                        <div className="max-w-5xl mx-auto space-y-10 text-left">
                            <div className="flex justify-between items-center text-left">
                                <h2 className="text-2xl font-black uppercase italic text-slate-900 text-left">Užsakymo projektai</h2>
                                <button onClick={handleAddProject} className="bg-[#00A650] text-white px-6 py-2.5 rounded-xl font-black uppercase text-[10px] shadow-lg flex items-center gap-2 hover:opacity-90 transition-all text-center">
                                    <Icons.Plus /> Naujas projektas (kampanija)
                                </button>
                            </div>

                            <div className="space-y-8 text-left">
                                {projects.map((proj, pIdx) => {
                                    const stats = calculateProjectStats(proj);
                                    const startWeek = getWeekNumber(new Date(proj.startDate));
                                    const endWeek = getWeekNumber(new Date(proj.endDate));

                                    return (
                                        <div key={proj.id} className="bg-white border-2 border-slate-100 rounded-[2.5rem] overflow-hidden shadow-sm hover:border-[#00A650] transition-all text-left">
                                            <div className="bg-slate-50 p-6 border-b border-slate-100 flex justify-between items-center text-left">
                                                <div className="flex gap-10 text-left">
                                                    <div><span className="text-[8px] font-black text-slate-400 uppercase tracking-widest block mb-1 text-left">Kampanija</span><span className="text-sm font-black text-slate-800 italic uppercase text-left">{proj.name || 'Be pavadinimo'}</span></div>
                                                    <div>
                                                        <span className="text-[8px] font-black text-slate-400 uppercase tracking-widest block mb-1 text-left">Laikotarpis</span>
                                                        <span className="text-sm font-black text-slate-600 italic uppercase text-left">{proj.startDate} — {proj.endDate}</span>
                                                        <span className="text-[10px] text-slate-400 ml-2 font-bold">({stats.durationDays} d., Sav. {startWeek}-{endWeek})</span>
                                                    </div>
                                                    <div><span className="text-[8px] font-black text-slate-400 uppercase tracking-widest block mb-1 text-left">Dažnis</span><span className="text-sm font-black text-slate-600 italic uppercase text-left">{proj.frequency.label}</span></div>
                                                </div>
                                                <div className="flex items-center gap-4 text-left">
                                                    <div className="text-right text-left"><span className="text-[8px] font-black text-slate-400 uppercase tracking-widest block mb-1 uppercase text-right">Projekto suma</span><span className="text-lg font-black text-[#00A650] italic text-right">€{stats.price.toLocaleString()}</span></div>
                                                    <button onClick={() => setScreenSelectorProjectIdx(pIdx)} className="p-2 bg-white border border-slate-200 rounded-lg text-slate-400 hover:text-[#00A650] hover:border-[#00A650] transition-all text-center" title="Pridėti LED ekranus"><Icons.Plus size={14}/></button>
                                                    <button onClick={() => { setEditingProject(proj); setIsProjectModalOpen(true); }} className="p-2 bg-white border border-slate-200 rounded-lg text-slate-400 hover:text-blue-500 hover:border-blue-500 transition-all text-center"><Icons.Edit size={14}/></button>
                                                </div>
                                            </div>
                                            <div className="p-6 text-left">
                                                {proj.selectedScreens.length === 0 ? (
                                                    <div className="text-center py-6 text-slate-300 italic text-xs font-black uppercase tracking-widest cursor-pointer hover:text-slate-400 text-center" onClick={() => { setEditingProject(proj); setIsProjectModalOpen(true); setIsScreenSelectOpen(true); }}>
                                                        Pridėkite LED ekranus šiam projektui...
                                                    </div>
                                                ) : (
                                                    <div className="overflow-x-auto custom-scrollbar">
                                                        <table className="w-full border-collapse text-left min-w-full">
                                                            <thead className="text-[9px] font-black uppercase text-slate-400 border-b border-slate-100 text-left whitespace-nowrap">
                                                                <tr>
                                                                    <th className="pb-3 text-left pl-2">#</th>
                                                                    <th className="pb-3 text-left">Kodas</th>
                                                                    <th className="pb-3 text-left">Miestas</th>
                                                                    <th className="pb-3 text-left">Adresas</th>
                                                                    <th className="pb-3 text-left">Rezoliucija</th>
                                                                    <th className="pb-3 text-left">Plotas</th>
                                                                    <th className="pb-3 text-left">Tipas</th>
                                                                    <th className="pb-3 text-center">OTS</th>
                                                                    <th className="pb-3 text-center">Parod. sk.</th>
                                                                    <th className="pb-3 text-right">Kaina (Gross)</th>
                                                                    <th className="pb-3 text-right pr-2">Kaina (Netto)</th>
                                                                </tr>
                                                            </thead>
                                                            <tbody className="divide-y divide-slate-50 text-left whitespace-nowrap">
                                                                {proj.selectedScreens.map((s, sIdx) => {
                                                                    const weeklyGross = Math.round(s.basePrice * proj.frequency.multiplier * (stats.slotsCount / 14));
                                                                    const totalGross = Math.round(weeklyGross * stats.weeks);
                                                                    const totalNet = Math.round(totalGross * (1 - (proj.discount || 80) / 100));
                                                                    
                                                                    const dailyGross = Math.round(weeklyGross / 7);
                                                                    const weeklyNet = Math.round(weeklyGross * (1 - (proj.discount || 80) / 100));
                                                                    const baseFreq = parseInt(proj.frequency.label) || (proj.frequency.label === 'Pikas' ? 4000 : 1200); 
                                                                    const totalShows = Math.round(baseFreq * (stats.slotsCount / 14) * stats.weeks);
                                                                    const totalOTS = Math.round(s.ots * stats.weeks);
                                                                    const pricePerShow = totalShows > 0 ? (totalNet / totalShows).toFixed(3) : 0;
                                                                    const cpt = totalOTS > 0 ? ((totalNet / totalOTS) * 1000).toFixed(2) : 0;

                                                                    return (
                                                                        <tr key={s.id} className="group text-left hover:bg-slate-50 transition-colors">
                                                                            <td className="py-3 pl-2 text-[10px] font-black text-slate-300 text-left">{sIdx+1}</td>
                                                                            <td className="py-3 text-[10px] font-bold text-slate-500 text-left">{s.id}</td>
                                                                            <td className="py-3 text-xs font-black uppercase italic text-slate-700 text-left">{s.city}</td>
                                                                            <td className="py-3 text-xs font-black text-slate-700 text-left">{s.screen}</td>
                                                                            <td className="py-3 text-[10px] font-medium text-slate-500 text-left">{s.resolution}</td>
                                                                            <td className="py-3 text-[10px] font-medium text-slate-500 text-left">{s.size}</td>
                                                                            <td className="py-3 text-[10px] font-bold text-slate-400 uppercase text-left">{s.type}</td>
                                                                            
                                                                            <td className="py-3 text-center text-slate-600 font-bold text-[10px]">{totalShows}</td>
                                                                            <td className="py-3 text-center text-slate-600 font-bold text-[10px]">{totalOTS.toLocaleString()}</td>
                                                                            
                                                                            <td className="py-3 text-right text-slate-500 text-[10px]">€{pricePerShow}</td>
                                                                            <td className="py-3 text-right text-slate-500 text-[10px]">€{cpt}</td>
                                                                            
                                                                            <td className="py-3 text-right text-slate-500 text-[10px]">€{dailyGross}</td>
                                                                            <td className="py-3 text-right text-slate-500 text-[10px]">€{weeklyNet}</td>
                                                                            
                                                                            <td className="py-3 text-right font-medium text-slate-400 text-xs text-right">€{totalGross}</td>
                                                                            <td className="py-3 pr-2 text-right font-black text-[#00A650] italic text-xs text-right">€{totalNet}</td>
                                                                        </tr>
                                                                    );
                                                                })}
                                                            </tbody>
                                                        </table>
                                                    </div>
                                                )}
                                            </div>
                                        </div>
                                    )
                                })}
                            </div>
                        </div>
                    </main>

                    <div className="fixed bottom-0 left-0 right-0 h-16 bg-slate-100 border-t-2 border-[#00A650] z-50 flex items-center justify-between px-6 no-print text-left">
                        <div className="flex items-center gap-8 text-left">
                            <div className="flex flex-col leading-none text-left">
                                <span className="text-[8px] font-black text-slate-400 uppercase tracking-widest mb-1 italic text-left">Projekto apžvalga</span>
                                <span className="text-xs font-black text-slate-600 uppercase italic leading-none text-left">{projects.length} dalys / {projects.reduce((acc,p)=>acc+p.selectedScreens.length,0)} ekranai</span>
                            </div>
                        </div>
                        <div className="flex items-center gap-2 text-left">
                            <button onClick={() => setIsPreviewOpen(true)} disabled={projects.length === 0} className="flex items-center gap-1.5 px-4 py-2 rounded-lg font-black uppercase text-[9px] bg-slate-200 text-slate-700 hover:bg-slate-300 transition-all text-center"><Icons.Eye size={12}/> Peržiūra</button>
                            <button onClick={handleFinishOrder} className="flex items-center gap-1.5 bg-slate-900 text-white px-5 py-2.5 rounded-lg font-black uppercase text-[9px] shadow-md hover:bg-black transition-all text-center">Išsaugoti visą užsakymą</button>
                        </div>
                    </div>

                    {/* MODALINIAI LANGAI */}
                    {isProjectModalOpen && (
                        <div className="modal-overlay fixed inset-0 z-[300] flex items-center justify-center p-6 text-left">
                            <div className="bg-white w-full max-w-7xl rounded-[3rem] shadow-2xl overflow-hidden flex flex-col h-[95vh] text-left">
                                <div className="p-8 bg-slate-900 text-white flex justify-between items-center text-left text-left">
                                    <h3 className="text-2xl font-black uppercase italic italic text-left">Formuoti projektą</h3>
                                    <button onClick={() => setIsProjectModalOpen(false)} className="p-3 bg-slate-800 hover:bg-red-500 text-white rounded-2xl transition-all text-center">×</button>
                                </div>
                                <div className="flex-1 overflow-hidden flex text-left">
                                    <div className="flex-1 p-10 space-y-8 overflow-y-auto custom-scrollbar text-left text-left text-left">
                                        <div className="space-y-6 text-left">
                                            <div className="space-y-1 text-left"><label className="text-[10px] font-black text-slate-400 uppercase tracking-widest ml-1 text-left">1. Kampanijos pavadinimas</label><input type="text" value={editingProject.name} onChange={e => setEditingProject({...editingProject, name: e.target.value})} className="w-full bg-slate-50 border-2 border-slate-100 rounded-2xl py-3.5 px-6 text-sm font-black focus:border-[#00A650] outline-none text-left" placeholder="Pvz. Piko kampanija" /></div>
                                            <div className="grid grid-cols-2 gap-4 text-left">
                                                <div className="space-y-1 text-left text-left"><label className="text-[10px] font-black text-slate-400 uppercase tracking-widest ml-1 text-left">2. Klipo trukmė</label><select value={editingProject.duration} onChange={e => setEditingProject({...editingProject, duration: e.target.value})} className="w-full bg-slate-50 border-2 border-slate-100 rounded-2xl py-3.5 px-6 text-sm font-black outline-none text-left"><option value="5s">5s</option><option value="10s">10s</option><option value="15s">15s</option><option value="20s">20s</option></select></div>
                                                <div className="space-y-1 text-left text-left"><label className="text-[10px] font-black text-slate-400 uppercase tracking-widest ml-1 text-left">3. Laikotarpis</label><div className="flex items-center gap-2 text-left"><input type="date" value={editingProject.startDate} onChange={e => setEditingProject({...editingProject, startDate: e.target.value})} className="flex-1 bg-slate-50 border-2 border-slate-100 rounded-2xl py-2 px-4 text-xs font-black outline-none text-left" /><input type="date" value={editingProject.endDate} onChange={e => setEditingProject({...editingProject, endDate: e.target.value})} className="flex-1 bg-slate-50 border-2 border-slate-100 rounded-2xl py-2 px-4 text-xs font-black outline-none text-left" /></div></div>
                                                <div className="col-span-2 text-[9px] text-slate-400 font-bold ml-1 flex gap-4">
                                                    {editingProject.startDate && editingProject.endDate && (
                                                        <>
                                                            <span>Trukmė: {Math.ceil(Math.abs(new Date(editingProject.endDate) - new Date(editingProject.startDate)) / (1000 * 60 * 60 * 24)) + 1} d.</span>
                                                            <span>Savaitės: {getWeekNumber(new Date(editingProject.startDate))} - {getWeekNumber(new Date(editingProject.endDate))}</span>
                                                        </>
                                                    )}
                                                </div>
                                            </div>
                                            <div className="space-y-1 text-left text-left text-left"><label className="text-[10px] font-black text-slate-400 uppercase tracking-widest ml-1 text-left text-left">4. Pastabos</label><textarea value={editingProject.notes} onChange={e => setEditingProject({...editingProject, notes: e.target.value})} className="w-full bg-slate-50 border-2 border-slate-100 rounded-2xl py-3.5 px-6 text-sm font-bold h-24 outline-none focus:border-[#00A650] text-left" placeholder="Papildoma informacija..."></textarea></div>
                                            
                                            {/* EKRANŲ PASIRINKIMO SEKCJA (IŠPLĖSTA) */}
                                            <div className="space-y-3 pt-4 border-t border-slate-100">
                                                <div className="flex justify-between items-center">
                                                    <div className="flex items-center gap-4">
                                                        <label className="text-[10px] font-black text-slate-400 uppercase tracking-widest ml-1">5. Pasirinkti ekranai ({editingProject.selectedScreens.length})</label>
                                                        <div className="flex items-center gap-2 bg-slate-100 px-3 py-1 rounded-lg">
                                                            <span className="text-[9px] font-bold text-slate-500 uppercase">Nuolaida:</span>
                                                            <input type="number" value={editingProject.discount} onChange={e => setEditingProject({...editingProject, discount: Number(e.target.value)})} className="w-10 bg-transparent text-[10px] font-black outline-none text-center" />
                                                            <span className="text-[9px] font-bold text-slate-500">%</span>
                                                        </div>
                                                    </div>
                                                    <button onClick={() => setIsScreenSelectOpen(true)} className="bg-slate-900 text-white px-5 py-2 rounded-xl font-black uppercase text-[10px] flex items-center gap-2 hover:bg-[#00A650] transition-all"><Icons.Plus size={12} /> Pridėti ekranus</button>
                                                </div>
                                                
                                                {editingProject.selectedScreens.length > 0 ? (
                                                    <div className="bg-slate-50 rounded-2xl border-2 border-slate-100 overflow-hidden">
                                                        <div className="overflow-x-auto custom-scrollbar">
                                                            <table className="w-full text-left min-w-full">
                                                                <thead className="bg-slate-100 text-[9px] font-black uppercase text-slate-500 whitespace-nowrap">
                                                                    <tr>
                                                                        <th className="p-3 pl-4 text-left">#</th>
                                                                        <th className="p-3 text-left">Kodas</th>
                                                                        <th className="p-3 text-left">Miestas</th>
                                                                        <th className="p-3 text-left">Adresas</th>
                                                                        <th className="p-3 text-left">Rezoliucija</th>
                                                                        <th className="p-3 text-left">Plotas</th>
                                                                        <th className="p-3 text-left">Tipas</th>
                                                                        <th className="p-3 text-center">Min. Parodymų</th>
                                                                        <th className="p-3 text-center">OTS</th>
                                                                        <th className="p-3 text-right">1 Parod.</th>
                                                                        <th className="p-3 text-right">CPT</th>
                                                                        <th className="p-3 text-right">1d. Gross</th>
                                                                        <th className="p-3 text-right">1sav. Net</th>
                                                                        <th className="p-3 text-right">Gross</th>
                                                                        <th className="p-3 text-right">Netto</th>
                                                                        <th className="p-3 w-10"></th>
                                                                    </tr>
                                                                </thead>
                                                                <tbody className="divide-y divide-slate-200 whitespace-nowrap">
                                                                    {editingProject.selectedScreens.map((s, idx) => {
                                                                        const diff = Math.ceil(Math.abs(new Date(editingProject.endDate) - new Date(editingProject.startDate)) / (1000 * 60 * 60 * 24));
                                                                        const weeks = Math.max(1, Math.round(diff / 7 * 10) / 10);
                                                                        const slots = Object.values(editingProject.gridSelection || {}).filter(Boolean).length || 0;
                                                                        
                                                                        const weeklyGross = Math.round(s.basePrice * editingProject.frequency.multiplier * (slots / 14));
                                                                        const gross = Math.round(weeklyGross * weeks);
                                                                        const net = Math.round(gross * (1 - (editingProject.discount || 80) / 100));
                                                                        
                                                                        const dailyGross = Math.round(weeklyGross / 7);
                                                                        const weeklyNet = Math.round(weeklyGross * (1 - (editingProject.discount || 80) / 100));
                                                                        const baseFreq = parseInt(editingProject.frequency.label) || (editingProject.frequency.label === 'Pikas' ? 4000 : 1200); 
                                                                        const totalShows = Math.round(baseFreq * (slots / 14) * weeks);
                                                                        const totalOTS = Math.round(s.ots * weeks);
                                                                        const pricePerShow = totalShows > 0 ? (net / totalShows).toFixed(3) : 0;
                                                                        const cpt = totalOTS > 0 ? ((net / totalOTS) * 1000).toFixed(2) : 0;

                                                                        return (
                                                                            <tr key={s.id} className="text-[11px] hover:bg-white transition-colors">
                                                                                <td className="p-3 pl-4 font-black text-slate-300">{idx+1}</td>
                                                                                <td className="p-3 font-bold text-slate-500">{s.id}</td>
                                                                                <td className="p-3 font-bold text-slate-700">{s.city}</td>
                                                                                <td className="p-3 font-bold text-slate-900">{s.screen}</td>
                                                                                <td className="p-3 text-slate-500">{s.resolution}</td>
                                                                                <td className="p-3 text-slate-500">{s.size}</td>
                                                                                <td className="p-3 text-slate-500 uppercase">{s.type}</td>
                                                                                <td className="p-3 text-center text-slate-600 font-bold">{totalShows}</td>
                                                                                <td className="p-3 text-center text-slate-600 font-bold">{totalOTS.toLocaleString()}</td>
                                                                                <td className="p-3 text-right font-medium text-slate-400">€{pricePerShow}</td>
                                                                                <td className="p-3 text-right font-medium text-slate-400">€{cpt}</td>
                                                                                <td className="p-3 text-right font-medium text-slate-400">€{dailyGross}</td>
                                                                                <td className="p-3 text-right font-medium text-slate-400">€{weeklyNet}</td>
                                                                                <td className="p-3 text-right font-medium text-slate-400">€{gross}</td>
                                                                                <td className="p-3 text-right font-black text-[#00A650]">€{net}</td>
                                                                                <td className="p-3 pr-4 text-right">
                                                                                    <button onClick={() => toggleScreenInEditingProject(s)} className="text-slate-300 hover:text-red-500 transition-colors"><Icons.Trash size={14}/></button>
                                                                                </td>
                                                                            </tr>
                                                                        );
                                                                    })}
                                                                </tbody>
                                                            </table>
                                                        </div>
                                                    </div>
                                                ) : (
                                                    <div className="text-center py-8 border-2 border-dashed border-slate-200 rounded-2xl text-slate-400 text-xs font-bold italic bg-slate-50">Nėra pasirinktų ekranų</div>
                                                )}
                                            </div>
                                        </div>
                                    </div>
                                    <div className="w-96 bg-slate-50 border-l border-slate-200 p-8 flex flex-col gap-6 text-left">
                                        <div className="text-left text-left">
                                            <span className="text-[10px] font-black text-slate-400 uppercase tracking-widest block mb-3 text-left">Dažnio parinkimas</span>
                                            <div className="grid grid-cols-2 gap-2 text-left">
                                                {WEEKLY_FREQUENCIES.map(f => (
                                                    <button key={f.id} onClick={() => updateGridByFrequency(f)} className={`py-3 rounded-xl text-[10px] font-black transition-all ${editingProject.frequency.id === f.id ? 'bg-[#00A650] text-white shadow-md' : 'bg-white border-2 border-slate-100 text-slate-400 hover:border-slate-200'} text-center`}>{f.label}</button>
                                                ))}
                                            </div>
                                        </div>
                                        <div className="flex-1 flex flex-col min-h-0 text-left">
                                            <span className="text-[10px] font-black text-slate-400 uppercase tracking-widest block mb-3 text-left">Tinklelis</span>
                                            <div className="bg-white border-2 border-slate-100 rounded-2xl overflow-hidden shadow-inner flex-1 overflow-y-auto custom-scrollbar text-left">
                                                <table className="w-full text-[8px] text-center border-collapse text-left">
                                                    <thead className="bg-slate-50 sticky top-0 border-b text-left"><tr><th className="p-1 border-r text-slate-400 text-left">V.</th>{DAYS.map(d=><th key={d}>{d}</th>)}</tr></thead>
                                                    <tbody>
                                                        {HOURS.map(h => (
                                                            <tr key={h} className="border-t border-slate-50 text-left">
                                                                <td className="bg-slate-50 border-r py-1 text-slate-400 font-bold text-left">{h.split(':')[0]}</td>
                                                                {DAYS.map(d => {
                                                                    const sel = editingProject.gridSelection[`${d}-${h}`];
                                                                    return <td key={d} onClick={() => setEditingProject({...editingProject, gridSelection: {...editingProject.gridSelection, [`${d}-${h}`]: !sel}})} className={`cursor-pointer h-4 transition-all ${sel ? 'bg-[#00A650]' : 'hover:bg-slate-50'}`}></td>
                                                                })}
                                                            </tr>
                                                        ))}
                                                    </tbody>
                                                </table>
                                            </div>
                                        </div>
                                    </div>
                                </div>
                                <div className="p-8 bg-white border-t flex justify-end gap-4 text-left">
                                    <button onClick={() => setIsProjectModalOpen(false)} className="px-10 py-4 text-slate-400 font-black uppercase text-xs text-center">Atšaukti</button>
                                    <button onClick={saveProject} className="bg-[#00A650] text-white px-12 py-4 rounded-2xl font-black uppercase text-xs shadow-lg hover:opacity-90 active:scale-95 transition-all text-center">Išsaugoti projektą</button>
                                </div>
                            </div>
                        </div>
                    )}

                    {/* MODALINIS: EKRANŲ SĄRAŠAS (OVERLAY) */}
                    {isScreenSelectOpen && (
                        <div className="modal-overlay fixed inset-0 z-[400] flex items-center justify-center p-6 text-left no-print">
                            <div className="bg-white w-full max-w-4xl h-[85vh] rounded-[3rem] shadow-2xl overflow-hidden flex flex-col text-left text-left">
                                <div className="p-8 bg-slate-900 text-white flex justify-between items-center text-left text-left">
                                    <div className="text-left"><h3 className="text-2xl font-black uppercase italic italic text-left">Pasirinkite ekranus</h3><p className="text-[10px] font-bold text-slate-400 uppercase tracking-widest text-left">Projektui: {editingProject.name || 'Naujas'}</p></div>
                                    <button onClick={() => setIsScreenSelectOpen(false)} className="p-3 bg-slate-800 hover:bg-red-500 text-white rounded-2xl transition-all text-center">Baigti</button>
                                </div>
                                <div className="p-4 bg-slate-50 border-b flex gap-4 text-left text-left text-left">
                                    <div className="relative flex-1 text-left text-left">
                                        <div className="absolute left-4 top-1/2 -translate-y-1/2 text-slate-300 text-left"><Icons.Search /></div>
                                        <input type="text" placeholder="Ieškoti LED ekrano..." value={searchTerm} onChange={e => setSearchTerm(e.target.value)} className="w-full bg-white border-2 border-slate-100 rounded-2xl py-3 pl-12 text-sm font-bold outline-none focus:border-[#00A650] text-left text-left" />
                                    </div>
                                </div>
                                <div className="flex-1 overflow-y-auto custom-scrollbar p-6 text-left text-left text-left">
                                    <table className="w-full border-collapse text-left text-left text-left">
                                        <tbody className="divide-y divide-slate-100 text-left text-left text-left">
                                            {filteredScreens.map(s => {
                                                const isSel = editingProject.selectedScreens.some(es => es.id === s.id);
                                                return (
                                                    <tr key={s.id} onClick={() => toggleScreenInEditingProject(s)} className="hover:bg-slate-50 cursor-pointer transition-all text-left">
                                                        <td className="p-4 w-12 text-center text-center"><div className={`w-6 h-6 rounded-lg border-2 transition-all flex items-center justify-center ${isSel ? 'bg-[#00A650] border-[#00A650] text-white' : 'bg-white border-slate-200'}`}>{isSel && <Icons.Check size={14}/>}</div></td>
                                                        <td className="p-4 text-xs font-black uppercase italic text-slate-700 text-left">{s.city}</td>
                                                        <td className="p-4 text-xs font-black text-slate-700 text-left">{s.screen}</td>
                                                        <td className="p-4 text-right font-black text-slate-900 italic text-right">€{s.basePrice}</td>
                                                    </tr>
                                                );
                                            })}
                                        </tbody>
                                    </table>
                                </div>
                            </div>
                        </div>
                    )}

                    {/* PDF PERŽIŪRA */}
                    {isPreviewOpen && (
                        <div className="modal-overlay fixed inset-0 z-[500] flex items-center justify-center p-10 no-print text-left">
                            <div className="bg-white w-full max-w-5xl h-full rounded-[2.5rem] shadow-2xl overflow-hidden flex flex-col text-left">
                                <div className="p-6 bg-slate-900 text-white flex justify-between items-center text-left">
                                    <div className="flex items-center gap-4 text-left text-left">
                                        <Icons.Eye size={20} className="text-[#00A650]" />
                                        <div className="text-left text-left"><h2 className="text-xl font-black uppercase italic text-left text-left">Pasiūlymo peržiūra</h2><p className="text-[9px] font-bold text-slate-400 uppercase tracking-widest text-left text-left">Statusas: {orderMeta.status || 'Pasiūlymas'}</p></div>
                                    </div>
                                    <div className="flex items-center gap-3 text-left">
                                        <button onClick={() => window.print()} className="bg-[#00A650] text-white px-6 py-2.5 rounded-xl font-black uppercase text-[10px] shadow-lg text-center">Spausdinti / PDF</button>
                                        <button onClick={() => setIsPreviewOpen(false)} className="p-2.5 bg-slate-800 hover:bg-red-500 text-white rounded-xl transition-all text-center text-center">×</button>
                                    </div>
                                </div>
                                <div className="flex-1 overflow-y-auto bg-slate-200/30 p-8 custom-scrollbar text-left text-left text-left">
                                    <div className="bg-white mx-auto shadow-2xl p-12 min-h-[1122px] w-full max-w-[800px] flex flex-col relative overflow-hidden text-left" id="offer-document">
                                        <div className="absolute top-0 left-0 right-0 h-2 bg-slate-900 text-left"></div>
                                        <div className="flex justify-between items-start mb-12 text-left">
                                            <Logo size="text-2xl" />
                                            <div className="text-right text-left text-left">
                                                <h1 className="text-3xl font-black uppercase italic text-slate-900 mb-2 text-left text-left">{orderMeta.status === 'Užsakymas' ? 'Užsakymas' : 'Pasiūlymas'}</h1>
                                                <div className="text-[10px] font-bold text-slate-500 uppercase tracking-widest text-left text-left">Nr: {orderMeta.nr || '-'} | {orderMeta.date}</div>
                                            </div>
                                        </div>
                                        <div className="grid grid-cols-2 gap-10 mb-8 border-y border-slate-100 py-6 text-left text-left">
                                            <div className="text-left text-left text-left text-left"><span className="text-[9px] font-black text-slate-400 uppercase block mb-1 text-left text-left">Užsakovas / Klientas</span><span className="text-sm font-black text-slate-800 italic uppercase text-left text-left">{orderMeta.customer || '-'} / {orderMeta.agent || '-'}</span></div>
                                            <div className="text-right text-left text-left text-left text-left text-left"><span className="text-[9px] font-black text-slate-400 uppercase block mb-1 text-left text-left">Galutinė projekto suma</span><span className="text-3xl font-black text-[#00A650] italic tracking-tighter leading-none text-left text-left text-left text-left text-left text-left text-left">€{totalOrderPrice.toLocaleString()}</span></div>
                                        </div>
                                        <div className="space-y-12 text-left text-left text-left text-left">
                                            {projects.map((proj, idx) => {
                                                const stats = calculateProjectStats(proj);
                                                if (proj.selectedScreens.length === 0) return null;
                                                return (
                                                    <div key={proj.id} className="text-left text-left text-left">
                                                        <div className="flex justify-between items-end mb-4 border-b-2 border-slate-900 pb-2 text-left text-left text-left">
                                                            <div className="text-left text-left text-left">
                                                                <h3 className="text-md font-black uppercase italic text-slate-900 text-left text-left text-left">PROJEKTAS: {proj.name || 'Dalis ' + (idx+1)}</h3>
                                                                <p className="text-[9px] font-bold text-slate-400 uppercase tracking-widest text-left text-left text-left text-left">Trukmė: {proj.duration} | Periodas: {proj.startDate} — {proj.endDate} | Dažnis: {proj.frequency.label}</p>
                                                            </div>
                                                            <span className="text-xs font-black text-[#00A650] italic text-right text-right text-right">Dalis: €{stats.price.toLocaleString()}</span>
                                                        </div>
                                                        <div className="overflow-x-auto">
                                                            <table className="w-full text-[10px] mb-6 text-left text-left text-left">
                                                                <thead className="bg-slate-50 font-black uppercase text-[8px] text-slate-400 text-left text-left text-left whitespace-nowrap">
                                                                    <tr>
                                                                        <th className="py-2 px-2 text-left">Miestas</th>
                                                                        <th className="py-2 px-2 text-left">Ekranas</th>
                                                                        <th className="py-2 px-2 text-left">Tipas</th>
                                                                        <th className="py-2 px-2 text-center">Min. Parodymų</th>
                                                                        <th className="py-2 px-2 text-center">OTS</th>
                                                                        <th className="py-2 px-2 text-right">1d. Gross</th>
                                                                        <th className="py-2 px-2 text-right">1sav. Net</th>
                                                                        <th className="py-2 px-2 text-right">Viso Gross</th>
                                                                        <th className="py-2 px-2 text-right">Viso Netto</th>
                                                                    </tr>
                                                                </thead>
                                                                <tbody className="divide-y divide-slate-100 text-left text-left text-left whitespace-nowrap">
                                                                    {proj.selectedScreens.map(s => {
                                                                        const weeklyGross = Math.round(s.basePrice * proj.frequency.multiplier * (stats.slotsCount / 14));
                                                                        const totalGross = Math.round(weeklyGross * stats.weeks);
                                                                        const totalNet = Math.round(totalGross * (1 - (proj.discount || 80) / 100));
                                                                        const dailyGross = Math.round(weeklyGross / 7);
                                                                        const weeklyNet = Math.round(weeklyGross * (1 - (proj.discount || 80) / 100));
                                                                        const baseFreq = parseInt(proj.frequency.label) || (proj.frequency.label === 'Pikas' ? 4000 : 1200); 
                                                                        const totalShows = Math.round(baseFreq * (stats.slotsCount / 14) * stats.weeks);
                                                                        const totalOTS = Math.round(s.ots * stats.weeks);

                                                                        return (
                                                                            <tr key={s.id} className="text-left text-left text-left">
                                                                                <td className="py-2 px-2 font-bold text-slate-700 uppercase italic text-left">{s.city}</td>
                                                                                <td className="py-2 px-2 font-bold text-slate-700 uppercase italic text-left">{s.screen}</td>
                                                                                <td className="py-2 px-2 text-slate-500 uppercase">{s.type}</td>
                                                                                <td className="py-2 px-2 text-center text-slate-600 font-bold">{totalShows}</td>
                                                                                <td className="py-2 px-2 text-center text-slate-600 font-bold">{totalOTS.toLocaleString()}</td>
                                                                                <td className="py-2 px-2 text-right font-medium text-slate-400">€{dailyGross}</td>
                                                                                <td className="py-2 px-2 text-right font-medium text-slate-400">€{weeklyNet}</td>
                                                                                <td className="py-2 px-2 text-right font-medium text-slate-400">€{totalGross}</td>
                                                                                <td className="py-2 px-2 text-right font-black text-[#00A650]">€{totalNet}</td>
                                                                            </tr>
                                                                        );
                                                                    })}
                                                                </tbody>
                                                            </table>
                                                        </div>
                                                    </div>
                                                );
                                            })}
                                        </div>
                                        <div className="mt-8 border-t border-slate-100 pt-4">
                                            <p className="text-[10px] font-bold text-slate-500 uppercase">Vadybininkas</p>
                                            <p className="text-xs font-black text-slate-800">{orderMeta.manager}</p>
                                            <p className="text-[10px] text-slate-500">vaiva@ltadvert.lt</p>
                                        </div>
                                        <div className="mt-auto pt-12 text-[8px] text-slate-400 font-bold uppercase tracking-[0.3em] text-center border-t border-slate-100 italic italic text-center text-center text-center text-center">LT ADVERT — Lauko reklamos tinklas — www.ltadvert.lt</div>
                                    </div>
                                </div>
                            </div>
                        </div>
                    )}
                </div>
            );
        }

        const root = ReactDOM.createRoot(document.getElementById('root'));
        root.render(<App />);
    </script>
</body>
</html>
